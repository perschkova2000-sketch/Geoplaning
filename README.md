# Геопланирование и маршрутизация визитов

## Описание проекта

Данный проект реализует модуль геопланирования, предназначенный для автоматического
планирования визитов менеджеров к географически распределённым точкам в течение месяца.

Модуль принимает на вход файл с координатами точек и частотой их посещения,
самостоятельно распределяет точки между менеджерами, формирует помесячный график
с учётом рабочих дней и ограничений на дневную нагрузку, строит маршруты
и формирует итоговые отчёты и визуализации.

Решение ориентировано на использование в городах России и не требует платных API.

---

## Основные возможности

- автоматическое распределение точек между менеджерами;
- формирование календарного плана визитов на месяц;
- ограничение дневной нагрузки (не более 8–12 точек в день);
- обязательная маршрутизация с учётом дорожной сети;
- выявление необслуженных точек;
- визуализация маршрутов на карте;
- выгрузка результатов в Excel.

Среднее время работы кода: **5–10 минут** (зависит от количества точек и нагрузки на OSRM).

---

## Входные данные

На вход подаётся CSV-файл со следующими обязательными столбцами:

| Столбец | Описание |
|------|---------|
| point_id | уникальный идентификатор точки |
| latitude | широта |
| longitude | долгота |
| visits_per_month | сколько раз точку нужно посетить за месяц |

Опциональные столбцы:
- `service_time_min` — время обслуживания точки (в минутах).  
  Если отсутствует, используется значение по умолчанию.

Входной файл **НЕ содержит `manager_id`** — менеджеры назначаются автоматически.

---

## Логика и выбор алгоритмов

### 1. Назначение менеджеров

Точки автоматически распределяются между менеджерами с помощью географической
кластеризации (KMeans) по координатам.

Это позволяет:
- закрепить за каждым менеджером компактную территорию;
- снизить общее время в пути;
- избежать пересечения маршрутов.

### 2. Разворачивание визитов

Каждая точка с `visits_per_month = N` разворачивается в `N` отдельных визитов,
формируя очередь задач менеджера на месяц.

### 3. Распределение по дням

Визиты последовательно раскладываются по рабочим дням месяца:
- 1 менеджер → 1 маршрут в день;
- не более `MAX_POINTS_PER_DAY` визитов в день;
- если рабочих дней не хватает — визиты считаются необслуженными.

### 4. Маршрутизация

Для каждого дня и менеджера:
- строится маршрут с возвратом в офис;
- используется OSRM (Open Source Routing Machine);
- порядок посещения оптимизируется с помощью OR-Tools (TSP).

### 5. Визуализация

Маршруты визуализируются на интерактивной карте (folium),
с возможностью выбора конкретного дня.

---

## Конфигурация и настройки

Все основные параметры задаются в конфигурационном блоке.

### Загрузка данных
- `DATA_PATH` - путь до датасета с данными.

### Календарь
- `YEAR`, `MONTH` — период планирования (месяц и год соответственно);
- учитываются только рабочие дни (график 5/2, Россия).

### Менеджеры
- `N_MANAGERS` — количество менеджеров.

### Ограничения
- `MAX_POINTS_PER_DAY` — максимальное число точек в день;
- `MIN_POINTS_PER_DAY` — минимальное число точек в день;
- `MAX_TRAVEL_TIME_HOURS` — допустимое время в дороге (в часах);
- `WORKDAY_HOURS` — продолжительность рабочего дня (в часах).


### Обслуживание
- `DEFAULT_SERVICE_TIME_MIN` — время обслуживания точки по умолчанию.

### География
- `OFFICE_ADDRESS` — адрес офиса (геокодируется автоматически).

### Алгоритмы
- `RANDOM_SEED` — воспроизводимость кластеризации.

### Визуализация
- `VIZUALIZATION_DATE` - выбор даты для визуализации.

---

## Результаты работы

По итогам выполнения формируется Excel-файл с тремя листами:

### 1. Детальный план
- точка;
- менеджер;
- дата визита;
- порядок посещения.

### 2. План по дням
- дата;
- менеджер;
- список точек;
- количество точек;
- общее время (дорога + обслуживание);
- ссылка на маршрут в Яндекс Картах.

### 3. Необслуженные точки
- точки, которые не удалось разместить в календаре;
- расстояние от офиса.

---

### Запуск производится через файл `work_pipline`

## Интерпретация результатов
Если в листе «Необслуженные точки» есть записи, значит:
- текущего количества менеджеров недостаточно;
- или ограничения слишком жёсткие;
- или точки находятся слишком далеко.

План по дням отражает реальный выполнимый график,
а не теоретическое распределение.

## Ограничения и особенности
Используется бесплатный публичный OSRM:
- возможны ограничения по количеству запросов;
- для длинных маршрутов время может не рассчитываться.

В таких случаях маршрут сохраняется, а время помечается как NaN.

## Возможные улучшения модели
- учёт пробок и временных окон;
- балансировка нагрузки по времени, а не только по количеству точек;
- приоритеты точек;
- недельное планирование;
- собственный OSRM-сервер;
- кеширование маршрутов;
- web-интерфейс.
